<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Purificadora REM1</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, sans-serif;
        background: #f2f4f7;
        display: flex;
    }

    /* --- MENU LATERAL --- */
    .sidebar {
        width: 260px;
        height: 100vh;
        background: #1E1F26;
        color: white;
        display: flex;
        flex-direction: column;
        padding-top: 20px;
        position: fixed;
        left: 0;
        top: 0;
        box-shadow: 3px 0 10px rgba(0,0,0,0.2);
        transition: transform 0.3s ease;
    }

    .sidebar h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #00AEEF;
    }

    .btn-menu {
        padding: 15px 20px;
        margin: 5px 15px;
        background: #2A2B33;
        border-radius: 10px;
        cursor: pointer;
        transition: .2s;
        font-size: 16px;
    }

    .btn-menu:hover {
        background: #00AEEF;
        color: black;
    }

    /* --- RESPONSIVE --- */
    @media(max-width: 768px) {
        .menu-toggle {
            display: block;
        }
        .sidebar {
            transform: translateX(-100%);
        }
        .sidebar.show {
            transform: translateX(0);
        }
        .content {
            margin-left: 0;
            padding-top: 60px;
        }
    }

    .menu-toggle {
        display: none;
        position: fixed;
        top: 15px;
        left: 15px;
        background: #1E1F26;
        padding: 10px 14px;
        border-radius: 8px;
        color: white;
        font-size: 22px;
        cursor: pointer;
        z-index: 1000;
    }

    /* --- CONTENIDO --- */
    .content {
        margin-left: 260px;
        padding: 25px;
        width: calc(100% - 260px);
    }

    .card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .title {
        font-size: 22px;
        margin-bottom: 10px;
        color: #333;
    }

    .btnAction {
        padding: 10px 15px;
        margin: 5px;
        background: #00AEEF;
        color: #fff;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 16px;
    }

    .date-group {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
    }

    input[type="date"] {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }
</style>
</head>

<body>

<!-- Botón hamburguesa -->
<div class="menu-toggle" onclick="toggleMenu()">☰</div>

<!-- MENU LATERAL -->
<div class="sidebar" id="sidebar">
    <h2>Purificadora REM</h2>

    <div class="btn-menu" onclick="loadSection('Dashboard')">Dashboard</div>
    <div class="btn-menu" onclick="loadSection('Empleados')">Empleados</div>
    <div class="btn-menu" onclick="loadSection('Productos')">Productos</div>
    <div class="btn-menu" onclick="loadSection('cortes')">Cortes de Venta</div>
    <div class="btn-menu" onclick="loadSection('Inventario')">Inventario</div>
    <div class="btn-menu" onclick="loadSection('Clientes')">Clientes</div>
    <div class="btn-menu" onclick="loadSection('Inmobiliario')">Inmobiliario</div>
</div>

<!-- CONTENIDO CENTRAL -->
<div class="content">
    <div id="view" class="card">
        <h1 class="title">Bienvenido</h1>
        <p>Selecciona una opción del menú.</p>
    </div>
</div>

<script>

/* --------------------- FUNCIONES DE SECCIONES --------------------- */
function loadSection(section) {
    const view = document.getElementById("view");
    document.getElementById("sidebar").classList.remove("show");

    if (section === "Dashboard") {
        view.innerHTML = `
            <h1 class="title">Dashboard de Ventas</h1>

            <div class="date-group">
                <div>
                    <label>Fecha Inicio</label><br>
                    <input type="date" id="fechaInicio">
                </div>
                <div>
                    <label>Fecha Fin</label><br>
                    <input type="date" id="fechaFin">
                </div>
            </div>

            <button class="btnAction" onclick="cargarHoy()">Hoy</button>
            <button class="btnAction" onclick="cargarMes()">Este Mes</button>
            <button class="btnAction" onclick="cargarPersonalizado()">Personalizado</button>

            <div class="card">
                <canvas id="grafica"></canvas>
            </div>

            <div id="tablaDatos" class="card"></div>
        `;
        return;
    }

    view.innerHTML = `<h1 class="title">${section}</h1><p>Contenido próximamente...</p>`;
}

/* ----------------------- CARGAR JSON ----------------------- */
async function cargarVentasPorMes(year, month) {
    const mes = month.toString().padStart(2, "0");
    const url = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/VentaGral/VentaGral_${year}_${mes}.json`;

    try {
        const res = await fetch(url);

        if (!res.ok) return []; // si no existe el archivo

        const datos = await res.json();

        if (!Array.isArray(datos)) return [];

        return datos;
    } catch {
        return [];
    }
}

/* ---------------------- FILTROS ---------------------- */
async function cargarHoy() {
    if (chart) chart.destroy();

    const hoy = new Date();
    const datos = await cargarVentasPorMes(hoy.getFullYear(), hoy.getMonth() + 1);

    const f = hoy.toISOString().split("T")[0];
    const filtrados = datos.filter(v => v.Fecha === f);

    dibujar(filtrados, "hora");
}

async function cargarMes() {
    if (chart) chart.destroy();

    const hoy = new Date();
    const datos = await cargarVentasPorMes(hoy.getFullYear(), hoy.getMonth() + 1);

    dibujar(datos, "dia");
}

async function cargarPersonalizado() {
    const ini = document.getElementById("fechaInicio").value;
    const fin = document.getElementById("fechaFin").value;

    if (!ini || !fin) {
        alert("Selecciona ambas fechas");
        return;
    }

    const fi = new Date(ini);
    const ff = new Date(fin);

    let resultados = [];

    // CORRECCIÓN: impedir que "fi" sea modificado
    for (let d = new Date(fi.getTime()); d <= ff; d.setDate(d.getDate() + 1)) {
        const datos = await cargarVentasPorMes(d.getFullYear(), d.getMonth() + 1);

        const fechaActual = d.toISOString().split("T")[0];

        resultados.push(...datos.filter(x => x.Fecha === fechaActual));
    }

    dibujar(resultados, "auto");
}

/* ---------------------- GRAFICAR ---------------------- */
let chart = null;

function dibujar(data, modo) {

    if (chart) chart.destroy();

    let grupos = {};

    if (modo === "hora") {
        data.forEach(v => {
            const h = v.Hora?.substring(0, 2) || "00";
            grupos[h] = (grupos[h] || 0) + Number(v.Total || 0);
        });
    } 
    else if (modo === "dia") {
        data.forEach(v => {
            grupos[v.Fecha] = (grupos[v.Fecha] || 0) + Number(v.Total || 0);
        });
    } 
    else {
        // AUTO: si 1 día → horas, si varios días → días.
        const dias = new Set(data.map(v => v.Fecha));
        return dibujar(data, dias.size <= 1 ? "hora" : "dia");
    }

    const labels = Object.keys(grupos);
    const valores = Object.values(grupos);

    chart = new Chart(document.getElementById("grafica"), {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "Ventas",
                data: valores,
                backgroundColor: "rgba(0, 174, 239, .6)"
            }]
        }
    });

    // TABLA
    let html = `
        <table border="1" style="width:100%; border-collapse: collapse;">
            <tr><th>Grupo</th><th>Total</th></tr>
    `;

    labels.forEach((g, i) => {
        html += `<tr><td>${g}</td><td>$${valores[i].toFixed(2)}</td></tr>`;
    });

    html += "</table>";
    document.getElementById("tablaDatos").innerHTML = html;
}

/* ------------------- TOGGLE MENU ------------------- */
function toggleMenu() {
    document.getElementById("sidebar").classList.toggle("show");
}

</script>

</body>
</html>
