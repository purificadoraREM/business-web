<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Purificadora REM</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
:root {
    --card-bg: #ffffff;
    --primary: #00AEEF;
    --text: #222;
    --shadow: 0 8px 20px rgba(0,0,0,0.08);
    --radius: 14px;
}

body {
    margin: 0;
    display: flex;
    background: #f5f7fb;
    font-family: "Segoe UI", sans-serif;
}
/* Sidebar */
.sidebar {
    width: 260px;
    background: #1E1F26;
    color: #fff;
    position: fixed;
    top: 0; left: 0;
    height: 100vh;
    padding-top: 25px;
    box-shadow: 4px 0 20px rgba(0,0,0,0.3);
    transition: transform 0.3s ease;
}
.sidebar h2 {
    text-align: center;
    color: var(--primary);
    font-size: 22px;
    margin-bottom: 30px;
}
.btn-menu {
    margin: 8px 15px;
    padding: 12px;
    background: #282A33;
    border-radius: 10px;
    cursor: pointer;
    transition: .2s;
    font-size: 15px;
}
.btn-menu:hover {
    background: var(--primary);
    color: #000;
}

/* Content */
.content {
    margin-left: 260px;
    padding: 25px;
    width: calc(100% - 260px);
}

.card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 20px;
}

.title {
    font-size: 26px;
    margin-bottom: 15px;
    font-weight: bold;
}

button.btnAction {
    padding: 10px 18px;
    background: var(--primary);
    border: none;
    color: white;
    border-radius: 10px;
    cursor: pointer;
    transition: .2s;
    font-weight: bold;
    margin-right: 10px;
}
button.btnAction:hover {
    background: #0086bd;
}

    .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    padding: 25px;
    width: 380px;
    border-radius: 10px;
    box-shadow: 0px 0px 15px #0003;
}

    .modal1 { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center;
align-items: center; z-index: 999; }

.modal-content1 { background: white; width: 380px; padding: 25px;
border-radius: 12px; box-shadow: 0 4px 18px rgba(0, 0, 0, 0.25);
text-align: center; }

.modal-content1 h2 { margin-top: 0; margin-bottom: 20px; }

.form-row1 { display: flex; flex-direction: column; margin-bottom: 15px;
text-align: left; }

.form-row1 label { font-weight: bold; margin-bottom: 5px; }

.form-row1 input[type=‚Äútime‚Äù] { padding: 8px; font-size: 15px;
border-radius: 6px; border: 1px solid #ccc; }

.modal-buttons1 { margin-top: 20px; display: flex; justify-content:
space-between; }

.btnAction1 { padding: 10px 18px; background: #4aa3ff; color: white;
font-size: 15px; border: none; border-radius: 6px; cursor: pointer;
flex: 1; margin: 0 4px; }

.btnCancel1 { background: #888; }
   

/* =========================================================
   ESTILOS GASTOS PREMIUM ‚Äî TOTALMENTE AISLADOS
========================================================= */

.gastos-premium .title {
    font-size: 32px;
    font-weight: 800;
    color: #1f2937;
    margin-bottom: 25px;
}

.gastos-premium .card {
    background: #ffffff;
    border-radius: 14px;
    padding: 28px;
    margin-bottom: 35px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}

.gastos-premium .card-title {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 20px;
    color: #374151;
}

/* GRID */
.gastos-premium .grid-2-premium {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 22px;
}

.gastos-premium .full {
    grid-column: span 2;
}

/* INPUTS CON ICONO */
.gastos-premium .input-icon {
    position: relative;
}

.gastos-premium .icon {
    position: absolute;
    top: 50%;
    left: 12px;
    transform: translateY(-50%);
    font-size: 17px;
    opacity: 0.6;
    pointer-events: none;
}

.gastos-premium .textarea-icon .icon {
    top: 16px; /* Ajuste especial textarea */
}

/* INPUT PREMIUM */
.gastos-premium .input {
    width: 100%;
    padding: 12px 14px 12px 38px;
    border-radius: 10px;
    background: #f3f4f6;
    border: 2px solid transparent;
    font-size: 15px;
    transition: 0.2s;
}

.gastos-premium .input:focus {
    background: #ffffff;
    border-color: #3b82f6;
    box-shadow: 0 0 6px rgba(59,130,246,0.25);
    outline: none;
}

/* Textarea */
.gastos-premium .textarea {
    height: 90px;
    resize: none;
}

/* SELECT PREMIUM */
.gastos-premium .select-premium {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M2 4 l4 4 4 -4' stroke='%23838' stroke-width='2' fill='none'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: calc(100% - 12px) center;
    cursor: pointer;
}

/* BOT√ìN PREMIUM */
.gastos-premium .btn-premium {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    border: none;
    padding: 14px 20px;
    width: 100%;
    font-size: 17px;
    border-radius: 12px;
    color: white;
    cursor: pointer;
    margin-top: 25px;
    transition: 0.25s;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.gastos-premium .btn-premium:hover {
    background: linear-gradient(135deg, #1e3a8a, #1d4ed8);
    transform: translateY(-2px);
    box-shadow: 0 8px 22px rgba(0,0,0,0.18);
}

/* Tabla */
.gastos-premium .table-container {
    max-height: 500px;
    overflow-y: auto;
    overflow-x: auto;
}

/* RESPONSIVE */
@media (max-width: 750px) {
    .gastos-premium .grid-2-premium {
        grid-template-columns: 1fr;
    }
}


    
/* Contenedor botones + tarjeta */
#controlRow {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}
#totalCard {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 12px 20px;
    background: #fff;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    font-size: 18px;
    font-weight: bold;
    color: var(--primary);
    margin-left: auto;
}

/* Inputs fecha */
input[type="date"], input[type="number"] {
    padding: 7px 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

/* Contenedor de gr√°ficos */
#chartsContainer {
    display: flex;
    gap: 20px;
    align-items: flex-start;
}
#chartWrapper, #pieWrapper {
    background: var(--card-bg);
    padding: 15px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}
#chartWrapper {
    width: 65%;
    height: 400px;
}
#pieWrapper {
    width: 35%;
    height: 400px;
}

/* Tabla */
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    padding: 8px 12px;
    border: 1px solid #ccc;
    text-align: center;
}

/* Responsive */
@media screen and (max-width: 768px){
    .content { margin-left: 0; width: 100%; padding: 10px; }
    .sidebar { transform: translateX(-100%); position: fixed; z-index: 10; }
    .sidebar.active { transform: translateX(0); }
    #chartsContainer { flex-direction: column; }
    #chartWrapper, #pieWrapper { width: 100%; height: 300px; }
}
/*--  tablas de corte  --*/
    .corte-table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 14px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-radius: 10px;
    overflow: hidden;
}

.corte-table thead {
    background: linear-gradient(90deg, #4e54c8, #8f94fb);
    color: white;
    font-weight: bold;
}

.corte-table th, .corte-table td {
    padding: 12px 15px;
    text-align: center;
}

.corte-table tbody tr {
    background: #ffffff;
    transition: background 0.3s, transform 0.2s;
}

.corte-table tbody tr:hover {
    background: #f1f1ff;
    transform: scale(1.02);
}

.corte-table tbody tr:nth-child(even) {
    background: #f9f9ff;
}

.corte-table .totales {
    font-weight: bold;
    background: #ecebff;
    border-top: 2px solid #4e54c8;
}

/* Tablas producto y movimientos */
.card table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}
.card table th, .card table td {
    padding: 8px 10px;
    border: 1px solid #ccc;
    text-align: center;
}
.card table th {
    background-color: #f0f0f0;
    font-weight: bold;
}
.card table tr:nth-child(even) {
    background-color: #fafafa;
}

    /* Bot√≥n de men√∫ m√≥vil */
#mobileMenuBtn {
    display: none;
    position: fixed;
    top: 12px;
    left: 12px;
    font-size: 28px;
    background: #1a73e8;
    color: white;
    padding: 8px 14px;
    border-radius: 6px;
    z-index: 9999;
    cursor: pointer;
}

/* Estilos solo para pantallas peque√±as */
@media (max-width: 768px) {

    #mobileMenuBtn {
        display: block;
    }

   @media (max-width: 768px) {

    #mobileMenuBtn {
        display: block;
    }

    /* Men√∫ m√≥vil redefiniendo la versi√≥n original */
    .sidebar {
        transform: translateX(-260px) !important;
        left: 0 !important;
        position: fixed;
        background: #1E1F26 !important;
        width: 260px !important;
        z-index: 9990;
        transition: transform .3s ease;
    }

    .sidebar.open {
        transform: translateX(0) !important;
    }

    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.4);
        z-index: 9980;
    }

    #overlay.show {
        display: block;
    }
       
}


    /* Oscurecer fondo cuando el men√∫ est√© abierto */
    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.4);
        z-index: 9980;
    }

    #overlay.show {
        display: block;
    }

    /* El contenido se hace m√°s peque√±o */
    #view {
        margin-left: 0 !important;
        padding: 20px;
    }
}    
</style>
</head>
<body>
<div id="mobileMenuBtn" onclick="toggleMenu()">‚ò∞</div>    
<div class="sidebar" id="sidebar">
    <h2>Purificadora REM</h2>    
    <div class="btn-menu" onclick="loadSection('Dashboard'); toggleMenu();">Ventas</div>
    <div class="btn-menu" onclick="loadSection('Empleados'); toggleMenu();">Empleados</div>
    <div class="btn-menu" onclick="loadSection('Productos'); toggleMenu();">Productos</div>    
    <div class="btn-menu" onclick="loadSection('Cortes'); toggleMenu();">Cortes</div>
    <div class="btn-menu" onclick="loadSection('Clientes'); toggleMenu();">Clientes</div>   
    <div class="btn-menu" onclick="loadSection('Inventario'); toggleMenu();">Inventario</div>    
      <div class="btn-menu" onclick="loadSection('Gastos'); toggleMenu();">Gastos</div>  
</div>
<div id="overlay" onclick="toggleMenu()"></div>

<div class="content">
    <div id="view" class="card">
        <h1>Bienvenido</h1>
        <p>Selecciona una opci√≥n del men√∫.</p>        
    </div>
</div>    
<script>
let barChart = null;
let pieChart = null;
let registrosDetalleFiltrados = [];

/* ============================================================
    CARGAR SECCI√ìN
============================================================ */
function loadSection(section) {
    const view = document.getElementById("view");

    if(section === "Dashboard") {
        view.innerHTML = `
            <h1 class="title">Registro de Ventas</h1>
            <div class="card">
                <div id="controlRow">
                    <button class="btnAction" onclick="cargarHoy()">Hoy</button>
                    <button class="btnAction" onclick="cargarMes()">Este Mes</button>
                    <input type="date" id="fechaInicio">
                    <input type="date" id="fechaFin">
                    <button class="btnAction" onclick="cargarPersonalizado()">Personalizado</button>
                    <button class="btnAction" onclick="exportarVentasExcel()">Exportar Excel</button>
                    <div id="totalCard">
                        <span>Total Ventas</span>
                        <span id="totalValor">$0.00</span>
                    </div>
                </div>
            </div>
            <div id="chartsContainer">
                <div id="chartWrapper">
                    <canvas id="grafica"></canvas>
                </div>
                <div id="pieWrapper">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        `;
    
}else if(section === "Empleados") {
    view.innerHTML = `
        <h1 class="title">Empleados</h1>

        <!-- CARD 1 - CONSULTAR ASISTENCIAS -->
        <div class="card">
            <h2>Asistencias</h2>
            <div id="controlEmpleado">
                <input type="date" id="fechaRegistroInicio">
                <input type="date" id="fechaRegistroFin">
                <button class="btnAction" onclick="cargarRegistros()">Buscar</button>
                <button class="btnAction" onclick="exportarAsistencias()">Exportar Excel</button>
            </div>
            <div id="tablaRegistros"></div>
        </div>

        <!-- MODAL OCULTO -->
        <div id="modalEdicion" class="modal" style="display:none;">
            <div class="modal-content1">
                <h2>Modificar Horas</h2>

                <div class="form-row1">
            <label for="modEntrada">Hora Entrada</label>
            <input type="time" id="modEntrada">
        </div>

                <div class="form-row1">
            <label for="modSalida">Hora Salida</label>
            <input type="time" id="modSalida">
        </div>
        
         <div class="form-row1">
            <label for="apiKeyInput">Clave de seguridad</label>
            <input type="password" id="apiKeyInput" placeholder="Ingresa tu clave">
        </div>

                <button class="btnAction1" onclick="guardarModificacion()">Guardar Cambios</button>
                <button class="btnAction1" style="background:#7f8c8d" onclick="cerrarModal()">Cancelar</button>
            </div>
        </div>

        <!-- CARD 2 - CALCULAR PAGO -->
        <div class="card">
            <h2>Calcular Pago</h2>
            <div id="controlPago">
                <input type="date" id="fechaPagoInicio">
                <input type="date" id="fechaPagoFin">
                <input type="number" id="pagoHora" placeholder="Pago por hora">
                <button class="btnAction" onclick="calcularPago()">Calcular</button>
            </div>
            <div id="resultadoPago"></div>
        </div>
    `;
}




else if(section === "Productos") {
    view.innerHTML = `
        <h1 class="title">Productos</h1>

        <!-- PANEL MOVIMIENTOS -->
        <div class="card">
            <h2>Movimientos</h2>
<div id="controlMovimientos" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
    <input type="date" id="fechaMovInicio">
    <input type="date" id="fechaMovFin">
    <button class="btnAction" onclick="cargarMovimientos()">Buscar</button>
    <button class="btnAction" onclick="exportarMovimientosExcel()">Exportar a Excel</button>
    <button class="btnAction" onclick="limpiarMovimientos()">Limpiar</button>
</div>
<div id="tablaMovimientos" style="max-height:400px; overflow-y:auto; overflow-x:auto; border:1px solid #ccc;"></div>

            
        </div>

        <!-- PANEL PRODUCTO -->
        <div class="card">
            <h2>Producto</h2>
            <div id="tablaProducto" style="overflow-x:auto;"></div>
        </div>

        <!-- PANEL PRODUCTO RELACIONADO -->
        <div class="card">
            <h2>Producto Relacionado</h2>
            <div id="tablaProductoRelacionado" style="overflow-x:auto;"></div>
        </div>
    `;

    // Cargar tablas de productos
    cargarProductos();
}
else if(section === "Cortes") {
    view.innerHTML = `
        <h1 class="title">Cortes de Venta</h1>
        <div class="card">
            <div id="controlCortes" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
                <input type="date" id="fechaCorteInicio">
                <input type="date" id="fechaCorteFin">
                <button class="btnAction" onclick="cargarCortes()">Buscar</button>
                <button class="btnAction" onclick="limpiarCortes()">Limpiar</button>
                <button class="btnAction" onclick="exportarCortesExcel()">Exportar a Excel</button>
            </div>
            <div id="tablaCortes" style="overflow-x:auto; max-height:400px; overflow-y:auto;"></div>
        </div>
    `;
}
else if(section === "Clientes") {
    view.innerHTML = `
        <h1 class="title">Clientes</h1>

        <div class="card" style="display:flex; gap:20px; flex-wrap:wrap;">

            <!-- LISTA DE CLIENTES -->
            <div id="contenedorClientes"
                style="
                    flex:1;
                    min-width:250px;
                    max-width:400px;
                    max-height:450px;
                    overflow-y:auto;
                    border: 1px solid #ccc;
                    padding: 10px;
                    border-radius: 8px;
                ">
            </div>

            <!-- HISTORIAL DEL CLIENTE -->
            <div id="historialCliente"
                class="card"
                style="
                    flex:2;
                    min-width:300px;
                    max-height:450px;
                    overflow-y:auto;
                ">
                <h2>Selecciona un cliente para ver su historial</h2>
            </div>
           
</div>


        </div>
    `;

    cargarClientes();
}

    else if(section === "Inventario") {
    view.innerHTML = `
        <h1 class="title">Inventario</h1>

        <div class="card">
            <h2>Movimientos de Inventario</h2>

            <div id="tablaInventario" style="max-height:500px; overflow-y:auto; overflow-x:auto;"></div>
        </div>
    `;

    // Cargar autom√°ticamente al mostrar la secci√≥n
    cargarInventario();
}
     else if(section === "Inventario") {
    view.innerHTML = `
        <h1 class="title">Inventario</h1>

        <div class="card">
            <h2>Movimientos de Inventario</h2>

            <div id="tablaInventario" style="max-height:500px; overflow-y:auto; overflow-x:auto;"></div>
        </div>
    `;

    // Cargar autom√°ticamente al mostrar la secci√≥n
    cargarInventario();
}
else if (section === "Gastos") {
    view.innerHTML = `
        <div class="gastos-portal gastos-premium">

            <h1 class="title">üíº Registrar Gasto</h1>

            <div class="card form-card">
                <h2 class="card-title">Nuevo Gasto</h2>

                <div class="grid-2-premium">

                    <!-- Concepto -->
                    <div class="form-group">
                        <label>Concepto</label>
                        <div class="input-icon">
                            <span class="icon">üìù</span>
                            <input type="text" id="gastoConcepto" class="input">
                        </div>
                    </div>

                    <!-- Monto -->
                    <div class="form-group">
                        <label>Monto</label>
                        <div class="input-icon">
                            <span class="icon">üíµ</span>
                            <input type="number" id="gastoMonto" class="input">
                        </div>
                    </div>

                    <!-- M√©todo de Pago -->
                    <div class="form-group">
                        <label>M√©todo de Pago</label>
                        <div class="input-icon">
                            <span class="icon">üí≥</span>
                            <select id="gastoMetodo" class="input select-premium">
                                <option value="Tarjeta">Tarjeta</option>
                                <option value="Transferencia">Transferencia</option>
                                <option value="Efectivo">Efectivo</option>
                            </select>
                        </div>
                    </div>

                    <!-- Fecha -->
                    <div class="form-group">
                        <label>Fecha</label>
                        <div class="input-icon">
                            <span class="icon">üìÖ</span>
                            <input type="date" id="gastoFecha" class="input">
                        </div>
                    </div>

                    <!-- Notas -->
                    <div class="form-group full">
                        <label>Notas</label>
                        <div class="input-icon textarea-icon">
                            <span class="icon">üìò</span>
                            <textarea id="gastoNotas" class="input textarea"></textarea>
                        </div>
                    </div>

                    <!-- Clave de seguridad -->
                    <div class="form-group full">
                        <label>Clave de Seguridad</label>
                        <div class="input-icon">
                            <span class="icon">üîë</span>
                            <input type="password" id="apiKeyInput" class="input" placeholder="Ingresa tu clave">
                        </div>
                    </div>

                </div>

                <button class="btn-premium" onclick="enviarGasto()">Registrar Gasto</button>
            </div>

            <div class="card">
                <h2 class="card-title">üìÑ Historial de Gastos</h2>
                <div id="tablaGastos" class="table-container"></div>
            </div>

        </div>
    `;
}






    }


    
/* ============================================================
    FUNCIONES AUXILIARES
============================================================ */
function parseLocalDate(str) {
    const [y,m,d] = str.split("-").map(Number);
    return new Date(y,m-1,d);
}
function fechaToString(fecha) {
    const yyyy = fecha.getFullYear();
    const mm = String(fecha.getMonth()+1).padStart(2,'0');
    const dd = String(fecha.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
}
function formato12(hora24) {
    let h = parseInt(hora24);
    const suf = h >= 12 ? "PM" : "AM";
    h = h % 12 || 12;
    return `${h} ${suf}`;
}

/* ============================================================
    CARGA DE JSON
============================================================ */
async function cargarVentasPorMes(year, month) {
    const mes = month.toString().padStart(2,"0");
    const url = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/VentaGral/VentaGral_${year}_${mes}.json`;
    try { const res = await fetch(url); if(!res.ok) return []; return await res.json(); } catch { return []; }
}
async function cargarDetallePorMes(year, month) {
    const mes = month.toString().padStart(2,"0");
    const url = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/VentaDetalle/VentaDetalle_${year}_${mes}.json`;
    try { const res = await fetch(url); if(!res.ok) return []; return await res.json(); } catch { return []; }
}
async function cargarDetalleHoy(hoy){
    const detalles = await cargarDetallePorMes(hoy.getFullYear(), hoy.getMonth()+1);
    const hoyStr = fechaToString(hoy);
    return detalles.filter(v=>v.Fecha===hoyStr);
}

/* ============================================================
    BOTONES VENTAS
============================================================ */
async function cargarHoy() {
    document.getElementById("fechaInicio").value = "";
    document.getElementById("fechaFin").value = "";
    const hoy = new Date();
    const hoyStr = fechaToString(hoy);
    const datos = await cargarVentasPorMes(hoy.getFullYear(), hoy.getMonth()+1);
    const filtrado = datos.filter(v => v.Fecha === hoyStr);
    const detalleHoy = await cargarDetalleHoy(hoy);
    registrosDetalleFiltrados = detalleHoy;
    dibujarBarras(filtrado, "hora", hoy, hoy);
    dibujarPastel(await cargarDetalleHoy(hoy));
}
async function cargarMes() {
    document.getElementById("fechaInicio").value = "";
    document.getElementById("fechaFin").value = "";
    const hoy = new Date();
    const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth()+1, 0);
    const datos = await cargarVentasPorMes(hoy.getFullYear(), hoy.getMonth()+1);
    const detallesMes = await cargarDetallePorMes(hoy.getFullYear(), hoy.getMonth() + 1);
    registrosDetalleFiltrados = detallesMes;
    dibujarBarras(datos, "dia", primerDia, ultimoDia);
    dibujarPastel(await cargarDetallePorMes(hoy.getFullYear(), hoy.getMonth()+1));
}
async function cargarPersonalizado() {
    const ini = document.getElementById("fechaInicio").value;
    const fin = document.getElementById("fechaFin").value;
    if(!ini || !fin) return alert("Selecciona ambas fechas");
    const fi = parseLocalDate(ini);
    const ff = parseLocalDate(fin);

    let meses = [];
    let y = fi.getFullYear(), m = fi.getMonth()+1;
    const yFin = ff.getFullYear(), mFin = ff.getMonth()+1;
    while (y < yFin || (y===yFin && m<=mFin)) {
        meses.push({year:y, month:m});
        m++; if(m>12){ m=1; y++; }
    }

    let resultados = [];
    let detalles = [];
    for(let mes of meses){
        const dataMes = await cargarVentasPorMes(mes.year, mes.month);
        resultados.push(...dataMes.filter(v => v.Fecha>=ini && v.Fecha<=fin));
        const det = await cargarDetallePorMes(mes.year, mes.month);
        detalles.push(...det.filter(v => v.Fecha>=ini && v.Fecha<=fin));
    }

    let modo = "dia";
    if(fi.getTime()===ff.getTime()) modo="hora";
    else if(meses.length>1) modo="mes";
   
    dibujarBarras(resultados, modo, fi, ff);
    dibujarPastel(detalles);
    registrosDetalleFiltrados = detalles;
   
}

/* ============================================================
    DIBUJAR GR√ÅFICAS
============================================================ */
function dibujarBarras(data, modo, fi=null, ff=null){
    if(barChart) barChart.destroy();
    let grupos={};

    if(modo==="hora"){
        data.forEach(v=>{
            if(!v.Hora) return;
            let h=v.Hora.substring(0,2); h=formato12(h);
            grupos[h]=(grupos[h]||0)+Number(v.Total||0);
        });
    } else if(modo==="dia"){
        let current = new Date(fi.getTime());
        while(current<=ff){
            grupos[fechaToString(current)]=0;
            current.setDate(current.getDate()+1);
        }
        data.forEach(v=>{
            grupos[v.Fecha]=(grupos[v.Fecha]||0)+Number(v.Total||0);
        });
    } else if(modo==="mes"){
        const mesesN=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        data.forEach(v=>{
            const f=parseLocalDate(v.Fecha);
            if(f>=fi && f<=ff){
                const key=mesesN[f.getMonth()]+" "+f.getFullYear();
                grupos[key]=(grupos[key]||0)+Number(v.Total||0);
            }
        });
    }

    const labels=Object.keys(grupos);
    const valores=Object.values(grupos);
    const total=valores.reduce((a,b)=>a+b,0);
    document.getElementById("totalValor").innerText="$"+total.toFixed(2);

    barChart=new Chart(document.getElementById("grafica"),{
        type:"bar",
        data:{ labels, datasets:[{ data:valores, backgroundColor:"rgba(0,174,239,0.75)", borderRadius:12 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
    });
}

function dibujarPastel(detalles){
    if(pieChart) pieChart.destroy();
    let grupos={};
    detalles.forEach(v=>{
        grupos[v.Articulo]=(grupos[v.Articulo]||0)+Number(v.Cantidad||0);
    });

    const labels=Object.keys(grupos);
    const valores=Object.values(grupos);

    pieChart=new Chart(document.getElementById("pieChart"),{
        type:"pie",
        data:{ labels, datasets:[{ data:valores, backgroundColor:["#00AEEF","#FF6B6B","#FFD93D","#6BCB77","#845EC2","#FF9671"] }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{tooltip:{callbacks:{label:function(ctx){return ctx.label+": "+ctx.raw;}}}, legend:{position:"bottom"}} }
    });
}

/* ============================================================
    EMPLEADOS - NUEVAS FUNCIONES
============================================================ */
function calcularHoras(hEntrada, hSalida) {

    if (hSalida === "NULL" || !hSalida) {
        return { horas: null, minutos: null };
    }

    const [h1,m1] = hEntrada.split(":").map(Number);
    const [h2,m2] = hSalida.split(":").map(Number);

    let start = h1 + m1/60;
    let end = h2 + m2/60;

    if(end < start) end += 24;

    const totalHoras = end - start;
    const horas = Math.floor(totalHoras);
    const minutos = Math.round((totalHoras - horas)*60);

    return { horas, minutos };
}

 /* ============================================================
    CARGAR REGISTROS EMPLEADOS
============================================================ */
async function cargarRegistros() {
    const fechaIni = document.getElementById("fechaRegistroInicio").value;
    const fechaFin = document.getElementById("fechaRegistroFin").value;

    if(!fechaIni || !fechaFin)
        return alert("Selecciona ambas fechas");

    // NO convertir a Date para evitar errores por zona horaria
    const fi = fechaIni;
    const ff = fechaFin;

    // obtener meses a cargar
    let meses = [];
    let y = Number(fi.slice(0,4));
    let m = Number(fi.slice(5,7));
    const yFin = Number(ff.slice(0,4));
    const mFin = Number(ff.slice(5,7));

    while (y < yFin || (y === yFin && m <= mFin)) {
        meses.push({ y, m });
        m++;
        if (m > 12) { m = 1; y++; }
    }

    let registros = [];

    for (const mes of meses) {
        const url = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/RegEmpleados/RegEmpleados_${mes.y}_${String(mes.m).padStart(2,'0')}.json`;
        try {
            const r = await fetch(url);
            if (r.ok) registros.push(...await r.json());
        } catch {}
    }

    // üëâ FILTRO DEFINITIVO (compara strings YYYY-MM-DD)
  const filtrados = registros
    .filter(r => r.Fecha >= fi && r.Fecha <= ff)
    .map(r => ({
        id: r.ID,              // ‚Üê IMPORTANTE
        empleado: r.Nombre,
        fecha: r.Fecha,
        entrada: r.HoraEntrada,
        salida: r.HoraSalida,
        estado: r.HoraSalida ? "Salida" : "Entrada"
    }));


    // Guardar para exportar si lo usas
    window.registros = filtrados;


    // Dibujar tabla
   let html = `
    <table>
        <tr>
            <th>ID</th>
            <th>Empleado</th>
            <th>Fecha</th>
            <th>Entrada</th>
            <th>Salida</th>
            <th>Horas trabajadas</th>
            <th>Acci√≥n</th>
        </tr>
`;

filtrados.forEach(e => {
    const calc = calcularHoras(e.entrada, e.salida);
    const horasTxt = calc.horas === null ? "‚Äî" : `${calc.horas}:${String(calc.minutos).padStart(2,'0')}`;

    html += `
        <tr>
            <td>${e.id}</td>
            <td>${e.empleado}</td>
            <td>${e.fecha}</td>
            <td>${e.entrada}</td>
            <td>${e.salida ?? "‚Äî"}</td>
            <td>${horasTxt}</td>
            <td>
                <button class="btnAction" onclick="abrirModal(${e.id})">Editar</button>
         <button class="btnAction" style="background:#c0392b" onclick="borrarRegistro(${e.id})">Borrar</button>
                  </td>
        </tr>
    `;
});


html += "</table>";
document.getElementById("tablaRegistros").innerHTML = html;

}



    /* ============================================================
    CALCULAR PAGO EMPLEADOS
============================================================ */
async function calcularPago() {
    const fechaIni = document.getElementById("fechaPagoInicio").value;
    const fechaFin = document.getElementById("fechaPagoFin").value;
    const pagoHora = parseFloat(document.getElementById("pagoHora").value);

    if(!fechaIni || !fechaFin || isNaN(pagoHora))
        return alert("Completa todos los campos");

    // Comparaci√≥n de strings YYYY-MM-DD (correcto)
    const fi = fechaIni;
    const ff = fechaFin;

    // --- CALCULAR MESES SIN USAR Date() ---
    let meses = [];
    let y = Number(fi.slice(0,4));
    let m = Number(fi.slice(5,7));

    const yEnd = Number(ff.slice(0,4));
    const mEnd = Number(ff.slice(5,7));

    while (y < yEnd || (y === yEnd && m <= mEnd)) {
        meses.push({ y, m });
        m++;
        if (m > 12) { m = 1; y++; }
    }

    // --- CARGAR REGISTROS ---
    let registros = [];

    for (const mes of meses) {
        const url = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/RegEmpleados/RegEmpleados_${mes.y}_${String(mes.m).padStart(2,'0')}.json`;
        try {
            const r = await fetch(url);
            if (r.ok) registros.push(...await r.json());
        } catch {}
    }

    // --- FILTRO SIN Date() ---
    const filtrados = registros.filter(e =>
        e.Fecha >= fi && e.Fecha <= ff
    );

    // --- CALCULAR PAGOS ---
    const pagos = {};
    const advertencias = [];

    filtrados.forEach(reg => {
        const calc = calcularHoras(reg.HoraEntrada, reg.HoraSalida);

        if (calc.horas === null) {
            advertencias.push(`‚ö† No se puede calcular el pago de ${reg.Nombre} el d√≠a ${reg.Fecha} porque no tiene hora de salida registrada.`);
            return;
        }

        const totalHoras = calc.horas + (calc.minutos / 60);

        if (!pagos[reg.Nombre]) pagos[reg.Nombre] = 0;
        pagos[reg.Nombre] += totalHoras;
    });

    // --- DIBUJAR TABLA ---
    let html = `
        <table>
            <tr>
                <th>Empleado</th>
                <th>Horas Totales</th>
                <th>Pago Total</th>
            </tr>
    `;

    for (const empleado in pagos) {
        html += `
            <tr>
                <td>${empleado}</td>
                <td>${pagos[empleado].toFixed(2)}</td>
                <td>$${(pagos[empleado] * pagoHora).toFixed(2)}</td>
            </tr>
        `;
    }

    html += "</table>";

    if (advertencias.length > 0) {
        html += `
            <div style="margin-top:15px; padding:12px; background:#ffe1e1; border-left:4px solid red;">
                <strong>Advertencias:</strong><br>
                ${advertencias.join("<br>")}
            </div>
        `;
    }

    document.getElementById("resultadoPago").innerHTML = html;
}


/* ============================================================
   exportar a excel
============================================================ */
function exportarAsistencias() {
    if (!window.registrosFiltradosExport || window.registrosFiltradosExport.length === 0) {
        return alert("No hay datos para exportar");
    }

    const data = window.registrosFiltradosExport.map(r => {
        const calc = calcularHoras(r.HoraEntrada, r.HoraSalida);
        return {
            "Empleado": r.Nombre,
            "Fecha": r.Fecha,
            "Entrada": r.HoraEntrada,
            "Salida": r.HoraSalida ?? "NULL",
            "Horas trabajadas": calc.horas === null ? "‚Äî" : `${calc.horas}:${String(calc.minutos).padStart(2,'0')}`
        };
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Asistencias");

    XLSX.writeFile(wb, "Asistencias.xlsx");
}


    /* ============================================================
   exportar Venta a Excel
============================================================ */

    function exportarVentasExcel() {

    if (!registrosDetalleFiltrados || registrosDetalleFiltrados.length === 0) {
        return alert("No hay datos cargados. Primero selecciona un rango o un d√≠a.");
    }

    const detalles = registrosDetalleFiltrados;

    /* ============================================
        HOJA 1: REGISTRO DE VENTAS (sin modificar)
    =============================================*/
    const hoja1 = XLSX.utils.json_to_sheet(detalles);

    /* ============================================
        HOJA 2: REPORTE SAT
    =============================================*/


let reporte = {};  

detalles.forEach(v => {
    const key = v.Articulo + "_" + v.PrecioUnitario + "_" + v.Iva;

    if (!reporte[key]) {
        reporte[key] = {
            Articulo: v.Articulo,
            CantidadVendida: 0,
            PrecioUnitario: Number(v.PrecioUnitario),
            Iva: 0,
            TotalVendido: 0
        };
    }

    // Sumar cantidad vendida
    reporte[key].CantidadVendida += Number(v.Cantidad);

    // Sumar IVA directo del JSON
    reporte[key].Iva += Number(v.Iva);

    // Sumar Total directo del JSON
    reporte[key].TotalVendido += Number(v.Total);
});

// Convertir objeto agrupado a arreglo
const reporteArr = Object.values(reporte);

// Total general (solo del TotalVendido)
const totalGeneral = reporteArr.reduce((acc, r) => acc + r.TotalVendido, 0);

// Agregar fila final
reporteArr.push({
    Articulo: "Total General",
    CantidadVendida: "",
    PrecioUnitario: "",
    Iva: "",
    TotalVendido: totalGeneral
});

const hoja2 = XLSX.utils.json_to_sheet(reporteArr);

        
    /* ============================================
        CREAR ARCHIVO
    =============================================*/
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, hoja1, "Registro de Ventas");
    XLSX.utils.book_append_sheet(wb, hoja2, "Reporte SAT");

    XLSX.writeFile(wb, "Ventas_Filtradas.xlsx");
}


 /* ============================================================
  productos y relacionados
============================================================ */
async function cargarProductos() {
    // PRODUCTO
    const urlProd = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/Producto/Producto.json`;
    let productos = [];
    try {
        const r = await fetch(urlProd);
        if(r.ok) productos = await r.json();
    } catch{}

    let htmlProd = `
        <table>
            <tr>
                <th>Nombre</th>
                <th>Descripcion</th>
                <th>Categoria</th>
                <th>StockMinimo</th>
                <th>StockActual</th>
                <th>Unidad</th>
            </tr>
    `;
    productos.forEach(p => {
        htmlProd += `
            <tr>
                <td>${p.Nombre}</td>
                <td>${p.Descripcion}</td>
                <td>${p.Categoria}</td>
                <td>${p.StockMinimo}</td>
                <td>${p.StockActual}</td>
                <td>${p.Unidad}</td>
            </tr>
        `;
    });
    htmlProd += "</table>";
    document.getElementById("tablaProducto").innerHTML = htmlProd;

    // PRODUCTO RELACIONADO
    const urlRel = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/ProductoRelacionado/ProductoRelacionado.json`;
    let prodRel = [];
    try {
        const r = await fetch(urlRel);
        if(r.ok) prodRel = await r.json();
    } catch{}

 let htmlRel = `
    <table>
        <tr>
            <th>ID Producto</th>
            <th>Producto</th>
            <th>ID Consumible</th>
            <th>Consumible</th>
            <th>Usuario</th>
        </tr>
`;

prodRel.forEach(p => {
    htmlRel += `
        <tr>
            <td>${p.IDProducto}</td>
            <td>${p.Producto}</td>
            <td>${p.IDConsumible}</td>
            <td>${p.Consumible}</td>
            <td>${p.Usuario}</td>
        </tr>
    `;
});

htmlRel += "</table>";
document.getElementById("tablaProductoRelacionado").innerHTML = htmlRel;

}


 /* ============================================================
   movimientos
============================================================ */

    
let movimientosFiltrados = []; // Datos filtrados para exportar

async function cargarMovimientos() {
    const ini = document.getElementById("fechaMovInicio").value;
    const fin = document.getElementById("fechaMovFin").value;

    if(!ini || !fin) return alert("Selecciona ambas fechas");

    const fIni = parseLocalDate(ini);
    const fFin = parseLocalDate(fin);

    // Cargar movimientos
    const url = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/Movimiento/Movimiento_${fIni.getFullYear()}_${String(fIni.getMonth()+1).padStart(2,'0')}.json`;
    let registros = [];
    try {
        const r = await fetch(url);
        if(r.ok) registros = await r.json();
    } catch{}

    // Filtrar por rango de fechas
    const filtrados = registros.filter(r => {
        const f = parseLocalDate(r.Fecha);
        return f >= fIni && f <= fFin;
    });

    movimientosFiltrados = filtrados; // Guardar para exportar

    // Crear tabla sin mostrar CostoUnitario
    let html = `
        <table>
            <tr>
                <th>MovimientoID</th>
                <th>ProductoID</th>
                <th>Tipo</th>
                <th>Cantidad</th>
                <th>Fecha</th>
                <th>StockAntesMov</th>
                <th>StockDespMov</th>
                <th>Referencia</th>
                <th>Observaciones</th>
            </tr>
    `;
    filtrados.forEach(r => {
        html += `
            <tr>
                <td>${r.MovimientoID}</td>
                <td>${r.ProductoID}</td>
                <td>${r.Tipo}</td>
                <td>${r.Cantidad}</td>
                <td>${r.Fecha}</td>
                <td>${r.StockAntesMov}</td>
                <td>${r.StockDespMov}</td>
                <td>${r.Referencia ?? ""}</td>
                <td>${r.Observaciones ?? ""}</td>
            </tr>
        `;
    });
    html += "</table>";

    document.getElementById("tablaMovimientos").innerHTML = html;
}

function exportarMovimientosExcel() {
    if(movimientosFiltrados.length === 0) return alert("No hay registros para exportar");

    const dataExport = movimientosFiltrados.map(r => ({
        MovimientoID: r.MovimientoID,
        ProductoID: r.ProductoID,
        Tipo: r.Tipo,
        Cantidad: r.Cantidad,
        Fecha: r.Fecha,
        StockAntesMov: r.StockAntesMov,
        StockDespMov: r.StockDespMov,
        Referencia: r.Referencia ?? "",
        Observaciones: r.Observaciones ?? ""
    }));

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(dataExport);
    XLSX.utils.book_append_sheet(wb, ws, "Movimientos");
    XLSX.writeFile(wb, "Movimientos.xlsx");
}
        
/* ============================================================
   Limpiar movimiento
============================================================ */

function limpiarMovimientos() {
    document.getElementById("fechaMovInicio").value = "";
    document.getElementById("fechaMovFin").value = "";
    document.getElementById("tablaMovimientos").innerHTML = "";
    movimientosFiltrados = [];
}



    let cortesFiltrados = []; // Para exportar y limpiar

    /*---------------------------------------
    cargar cortes
    ------------------------------------------*/

async function cargarCortes() {
    const ini = document.getElementById("fechaCorteInicio").value;
    const fin = document.getElementById("fechaCorteFin").value;

    if(!ini || !fin) return alert("Selecciona ambas fechas");

    const fi = ini;
    const ff = fin;

    // Calcular meses
    let meses = [];
    let y = Number(fi.slice(0,4));
    let m = Number(fi.slice(5,7));
    const yFin = Number(ff.slice(0,4));
    const mFin = Number(ff.slice(5,7));

    while (y < yFin || (y === yFin && m <= mFin)) {
        meses.push({ y, m });
        m++;
        if (m > 12) { m = 1; y++; }
    }

    // Cargar archivos
    let registros = [];
    for (const mes of meses) {
        const url = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/CortesVenta/CortesVenta_${mes.y}_${String(mes.m).padStart(2,'0')}.json`;
        try {
            const r = await fetch(url);
            if (r.ok) registros.push(...await r.json());
        } catch{}
    }

    // Filtrar por fechas
    const filtrados = registros.filter(r => r.Fecha >= fi && r.Fecha <= ff);
    cortesFiltrados = filtrados;

    if (filtrados.length === 0) {
        document.getElementById("tablaCortes").innerHTML =
            "<p>No se encontraron cortes para este rango</p>";
        return;
    }

    // Columnas amigables
    const columnas = {
        CorteID: "ID",
        Fecha: "Fecha",        
        TotalEfectivo: "Efectivo",
        TotalTarjeta: "Tarjeta",
        TotalTransferencia: "Transferencia",
        TotalVenta: "Total Venta",
        Gasto: "Gastos",        
        EfectivoContado: "Efectivo Contado",
        FondoFinal: "Fondo Final",
        Usuario: "Usuario"
    };

    // Totales
    let totalVenta=0, totalEfectivo=0, totalTarjeta=0, totalTransferencia=0, totalGasto=0;

    let html = `<table class="corte-table"><thead><tr>`;
    for(const key in columnas) html += `<th>${columnas[key]}</th>`;
    html += `</tr></thead><tbody>`;

    filtrados.forEach(r => {
        html += `<tr>`;
        for(const key in columnas){
            let value = r[key];
            if(["TotalVenta","TotalEfectivo","TotalTarjeta","TotalTransferencia","Gasto","EfectivoContado","FondoFinal"].includes(key)){
                value = "$"+Number(value).toLocaleString();
                if(key==="TotalVenta") totalVenta+=Number(r[key]);
                if(key==="TotalEfectivo") totalEfectivo+=Number(r[key]);
                if(key==="TotalTarjeta") totalTarjeta+=Number(r[key]);
                if(key==="TotalTransferencia") totalTransferencia+=Number(r[key]);
                if(key==="Gasto") totalGasto+=Number(r[key]);
            }
            html += `<td>${value}</td>`;
        }
        html += `</tr>`;
    });
/*---aqui organice  totales--*/
    
    // Fila de totales
    html += `<tr class="totales">
<td colspan="2">Totales</td>
<td>$${totalEfectivo.toLocaleString()}</td>
<td>$${totalTarjeta.toLocaleString()}</td>
<td>$${totalTransferencia.toLocaleString()}</td>
<td>$${totalVenta.toLocaleString()}</td>
<td>$${totalGasto.toLocaleString()}</td>
<td colspan="3"></td>
</tr>`;

    html += "</tbody></table>";
    document.getElementById("tablaCortes").innerHTML = html;
}

    

function exportarCortesExcel() {
    if(cortesFiltrados.length === 0) return alert("No hay registros para exportar");

    // Solo columnas relevantes
    const dataExport = cortesFiltrados.map(r => ({
        ID: r.CorteID,
        Fecha: r.Fecha,       
        Efectivo: r.TotalEfectivo,
        Tarjeta: r.TotalTarjeta,
        Transferencia: r.TotalTransferencia,
        "Total Venta": r.TotalVenta,
        Gastos: r.Gasto,        
        "Efectivo Contado": r.EfectivoContado,
        "Fondo Final": r.FondoFinal,
        Usuario: r.Usuario
    }));

    const ws = XLSX.utils.json_to_sheet(dataExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Cortes");
    XLSX.writeFile(wb, "Cortes.xlsx");
}


function limpiarCortes() {
    // Limpiar inputs
    const iniInput = document.getElementById("fechaCorteInicio");
    const finInput = document.getElementById("fechaCorteFin");
    if(iniInput) iniInput.value = "";
    if(finInput) finInput.value = "";

    // Limpiar array
    cortesFiltrados = [];

    // Limpiar tabla
    const tabla = document.getElementById("tablaCortes");
    if(tabla) tabla.innerHTML = "<p>B√∫squeda limpia. Selecciona fechas para cargar cortes.</p>";
}
    function toggleMenu() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");

    sidebar.classList.toggle("open");
    overlay.classList.toggle("show");
}


 
/* ============================================================
   CARGAR CLIENTES
============================================================ */
async function cargarClientes() {

    const contenedor = document.getElementById("contenedorClientes");

    // Mensaje inicial
    contenedor.innerHTML = `
        <div style="padding:20px; font-size:18px; text-align:center;">
            ‚è≥ Cargando informaci√≥n...
        </div>
    `;

    const hoy = new Date();
    const yearActual = hoy.getFullYear();
    const yearAnterior = yearActual - 1;

    let datos = [];
    let archivosCargados = 0;

    // Intento de cargar datos
    for (let y of [yearAnterior, yearActual]) {
        for (let m = 1; m <= 12; m++) {
            const mes = String(m).padStart(2, '0');
            const url = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/VentaDetalle/VentaDetalle_${y}_${mes}.json`;

            try {
                const res = await fetch(url);
                if (res.ok) {
                    const dataMes = await res.json();
                    datos.push(...dataMes);
                    archivosCargados++;
                }
            } catch (error) {
                console.error("Error cargando:", url);
            }
        }
    }

    // Si no carg√≥ nada
    if (archivosCargados === 0) {
        contenedor.innerHTML = `
            <div style="padding:20px; color:red; font-size:18px; text-align:center;">
                ‚ùå No se pudo cargar la informaci√≥n.
            </div>
        `;
        return;
    }

    let clientes = {};

    datos.forEach(v => {
        const cliente = v.Cliente?.trim() || "Sin nombre";
        if (["N/A","Ning√∫n Cliente Seleccionado","","-"].includes(cliente)) return;

        if (!clientes[cliente] || v.Fecha > clientes[cliente]) {
            clientes[cliente] = v.Fecha;
        }
    });

    // Si no hay clientes v√°lidos
    if (Object.keys(clientes).length === 0) {
        contenedor.innerHTML = `
            <div style="padding:20px; color:red; font-size:18px; text-align:center;">
                ‚ö†Ô∏è No se encontraron clientes.
            </div>
        `;
        return;
    }

    // Construcci√≥n de la tabla
    let html = `
        <table style="width:100%;">
            <tr>
                <th>Cliente</th>
                <th>√öltima Compra</th>
            </tr>
    `;

    const listaOrdenada = Object.entries(clientes).sort((a,b)=> a[1].localeCompare(b[1]));

    const hoyISO = new Date().toISOString().split("T")[0];

    listaOrdenada.forEach(([cliente, fecha]) => {
        const diasSinComprar = (new Date(hoyISO) - new Date(fecha)) / (1000 * 60 * 60 * 24);
        const styleRojo = diasSinComprar >= 7 ? "color:red;font-weight:bold;" : "";

        html += `
            <tr style="cursor:pointer;" onclick="mostrarHistorialCliente('${cliente}')">
                <td style="${styleRojo}">${cliente}</td>
                <td style="${styleRojo}">${fecha}</td>
            </tr>
        `;
    });

    html += "</table>";

    contenedor.innerHTML = html;
}


/* ============================================================
   MOSTRAR HISTORIAL DE UN CLIENTE (NUEVO)
============================================================ */
async function mostrarHistorialCliente(nombreCliente) {

    // Crear contenedor si no existe
    let panel = document.getElementById("historialCliente");
    if (!panel) {
        const view = document.getElementById("view");
        const div = document.createElement("div");
        div.id = "historialCliente";
        div.className = "card";
        view.appendChild(div);
        panel = div;
    }

    panel.innerHTML = `<h2>Historial de ${nombreCliente}</h2><p>Cargando...</p>`;

    // Cargar datos igual que cargarClientes()
    const hoy = new Date();
    const yearActual = hoy.getFullYear();
    const yearAnterior = yearActual - 1;

    let datos = [];

    for (let y of [yearAnterior, yearActual]) {
        for (let m = 1; m <= 12; m++) {
            const mes = String(m).padStart(2, '0');
            const url = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/VentaDetalle/VentaDetalle_${y}_${mes}.json`;

            try {
                const res = await fetch(url);
                if (res.ok) {
                    const dataMes = await res.json();
                    datos.push(...dataMes);
                }
            } catch {}
        }
    }

    // Filtrar historial del cliente
    const historial = datos.filter(v => v.Cliente?.trim() === nombreCliente);

    if (historial.length === 0) {
        panel.innerHTML = `
            <h2>Historial de ${nombreCliente}</h2>
            <p>No tiene compras registradas.</p>
        `;
        return;
    }

    // Ordenar desc por fecha
    historial.sort((a, b) => b.Fecha.localeCompare(a.Fecha));

    // üî• Calcular total comprado
    const totalComprado = historial.reduce((acc, h) => acc + Number(h.Total), 0);

    // HTML del indicador + bot√≥n exportar
    let html = `
        <h2>Historial de ${nombreCliente}</h2>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <!-- Indicador de total -->
            <div style="
                background:#00AEEF;
                color:white;
                padding:12px;
                border-radius:10px;
                font-size:18px;
                font-weight:bold;
                text-align:center;
            ">
                Total comprado: $${totalComprado.toFixed(2)}
            </div>

            <!-- Bot√≥n exportar Excel -->
            <button class="btnAction" onclick="exportarHistorialExcel('${nombreCliente}')">Exportar a Excel</button>
        </div>

        <table style="width:100%;">
            <tr>
                <th>Fecha</th>
                <th>Art√≠culo</th>
                <th>Cantidad</th>
                <th>Total</th>
            </tr>
    `;

    historial.forEach(h => {
        html += `
            <tr>
                <td>${h.Fecha}</td>
                <td>${h.Articulo}</td>
                <td>${h.Cantidad}</td>
                <td>$${Number(h.Total).toFixed(2)}</td>
            </tr>
        `;
    });

    html += "</table>";

    panel.innerHTML = html;
}

    /* ============================================================
   CARGAR INVENTARIO
============================================================ */
async function cargarInventario() {
    const cont = document.getElementById("tablaInventario");
    cont.innerHTML = "<p>Cargando datos...</p>";

    const hoy = new Date();
    const yearActual = hoy.getFullYear();
    const yearAnterior = yearActual - 1;

    let movimientos = [];

    // Cargar archivos de inventario de a√±o anterior y actual
    for (let y of [yearAnterior, yearActual]) {
        for (let m = 1; m <= 12; m++) {
            const mes = String(m).padStart(2, '0');
            const url = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/AjustesInventario/AjustesInventario_${y}_${mes}.json`;

            try {
                const res = await fetch(url);
                if (res.ok) {
                    const dataMes = await res.json();
                    movimientos.push(...dataMes);
                }
            } catch (e) {
                console.warn(`No se pudo cargar el archivo ${url}`);
            }
        }
    }

    // Construir tabla
    let html = `
        <table>
            <tr>
                <th>AjusteID</th>
                <th>ProductoID</th>
                <th>Tipo</th>
                <th>Cantidad</th>
                <th>Motivo</th>
                <th>Fecha</th>
                <th>Usuario</th>
            </tr>
    `;

    movimientos.forEach(m => {
        html += `
            <tr>
                <td>${m.AjusteID}</td>
                <td>${m.ProductoID}</td>
                <td>${m.Tipo}</td>
                <td>${m.CantidadAjustada}</td>
                <td>${m.Motivo}</td>
                <td>${m.Fecha}</td>
                <td>${m.Usuario}</td>
            </tr>
        `;
    });

    html += "</table>";
    cont.innerHTML = html;
}

/* ============================================================
   exportar excel
============================================================ */    

  async function exportarHistorialExcel(nombreCliente) {
    // Mostrar mensaje mientras carga
    const panel = document.getElementById("historialCliente");
    panel.innerHTML = `<h2>Historial de ${nombreCliente}</h2><p>Generando Excel...</p>`;

    // Obtener datos del historial igual que en mostrarHistorialCliente
    const hoy = new Date();
    const yearActual = hoy.getFullYear();
    const yearAnterior = yearActual - 1;

    let datos = [];

    for (let y of [yearAnterior, yearActual]) {
        for (let m = 1; m <= 12; m++) {
            const mes = String(m).padStart(2, '0');
            const url = `https://raw.githubusercontent.com/purificadoraREM/mi_negocio_data/main/data/VentaDetalle/VentaDetalle_${y}_${mes}.json`;
            try {
                const res = await fetch(url);
                if (res.ok) {
                    const dataMes = await res.json();
                    datos.push(...dataMes);
                }
            } catch {}
        }
    }

    // Filtrar historial del cliente
    const historial = datos.filter(v => v.Cliente?.trim() === nombreCliente);

    if (historial.length === 0) {
        alert("Este cliente no tiene compras registradas.");
        mostrarHistorialCliente(nombreCliente); // recargar vista
        return;
    }

    // Crear hoja de Excel
    const ws_data = [
        ["Fecha", "Art√≠culo", "Cantidad", "Total"]
    ];

    historial.forEach(h => {
        ws_data.push([h.Fecha, h.Articulo, h.Cantidad, Number(h.Total)]);
    });

    // Agregar fila final con total
    const totalComprado = historial.reduce((acc, h) => acc + Number(h.Total), 0);
    ws_data.push(["", "", "Total comprado", totalComprado]);

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Historial");

    // Descargar archivo
    XLSX.writeFile(wb, `Historial_${nombreCliente}.xlsx`);

    // Recargar vista del historial
    mostrarHistorialCliente(nombreCliente);
}


    /* ============================================================
  enviar gasto
============================================================ */  

async function enviarGasto() {
    const concepto = document.getElementById("gastoConcepto").value;
    const monto = document.getElementById("gastoMonto").value;
    const metodo = document.getElementById("gastoMetodo").value;
    const fecha = document.getElementById("gastoFecha").value;
    const notas = document.getElementById("gastoNotas").value;
    const apiKey = document.getElementById("apiKeyInput").value; // <- clave ingresada por el usuario
    const cajero = "Admin";

    // Validaci√≥n b√°sica
    if (!concepto || !monto || !fecha) {
        alert("Por favor, completa los campos obligatorios.");
        return;
    }

    if (!apiKey) {
        alert("Por favor, ingresa tu clave de seguridad.");
        return;
    }

    const gasto = {
        concepto,
        monto: parseFloat(monto),
        metodo,
        fecha,
        notas,
        cajero
    };

    try {
        const response = await fetch("https://rem.d5hx88s66m.workers.dev", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-api-key": apiKey // <- enviamos la clave que el usuario escribi√≥
            },
            body: JSON.stringify(gasto)
        });

        const result = await response.json();

        console.log("RESPUESTA DEL WORKER:", result);
        alert(JSON.stringify(result, null, 2));

        if (response.ok) {
            alert("Gasto enviado correctamente!");

            // limpiar campos
            document.getElementById("gastoConcepto").value = "";
            document.getElementById("gastoMonto").value = "";
            document.getElementById("gastoNotas").value = "";
            document.getElementById("apiKeyInput").value = ""; // limpiar clave tambi√©n
        } else {
            alert("Error al enviar gasto: " + (result.error || result));
        }

    } catch (error) {
        console.error(error);
        alert("No se pudo conectar con el servidor.");
    }
}

   
/* ============================================================
   fin
============================================================ */  
 
   
function abrirModal(id) {
    const registro = registros.find(r => r.id === id); // aseg√∫rate de que tu objeto tenga la propiedad ID
    if(!registro) return alert("Registro no encontrado");

    // llenar inputs con los valores actuales
   document.getElementById("modEntrada").value = formatearHora(registro.entrada);
    document.getElementById("modSalida").value = formatearHora(registro.salida);

    // guardar el id en el modal para usar al guardar
    document.getElementById("modalEdicion").dataset.registroId = id;

    document.getElementById("modalEdicion").style.display = "flex";
}

    function cerrarModal() {
    document.getElementById("modalEdicion").style.display = "none";
    document.getElementById("modalEdicion").dataset.registroId = "";
}

// Funci√≥n para formatear la hora en el formato HH:mm
function formatearHora(hora) {
    if (!hora) return "";  // Si no hay hora, retornamos una cadena vac√≠a

    // La hora debe tener el formato 'HH:mm:ss' para que funcione correctamente
    const partes = hora.split(":");
    if (partes.length < 2) return "";  // Si la hora no est√° bien formateada, devolvemos cadena vac√≠a

    // Retornamos la hora formateada como HH:mm
    return `${partes[0]}:${partes[1]}`;
}

// Funci√≥n para formatear las fechas en el formato correcto (YYYY-MM-DD)
const formatDate = (date) => {
    if (!date) return ""; // Si la fecha no est√° disponible, retornamos una cadena vac√≠a
    const d = new Date(date); // Crear un objeto Date
    if (isNaN(d.getTime())) return ""; // Verificar si la fecha es v√°lida
    return d.toISOString().split('T')[0]; // Extraemos solo la parte YYYY-MM-DD
};

// Funci√≥n para abrir el modal con la informaci√≥n del registro
function abrirModal(id) {
    const registro = window.registros.find(r => r.id === id); // asegurarnos de que el objeto tenga la propiedad ID
    if (!registro) return alert("Registro no encontrado");

    // Llenar los inputs con los valores actuales y formatear las horas
    document.getElementById("modEntrada").value = formatearHora(registro.entrada);  // Usamos formatearHora aqu√≠
    document.getElementById("modSalida").value = formatearHora(registro.salida);    // Usamos formatearHora aqu√≠

    // Guardar el id en el modal para usar al guardar
    document.getElementById("modalEdicion").dataset.registroId = id;

    document.getElementById("modalEdicion").style.display = "flex";
}

// Funci√≥n para cerrar el modal
function cerrarModal() {
    document.getElementById("modalEdicion").style.display = "none";
    document.getElementById("modalEdicion").dataset.registroId = "";
}

// Funci√≥n para guardar las modificaciones
async function guardarModificacion() {
    const id = document.getElementById("modalEdicion").dataset.registroId;
    const nuevaEntrada = document.getElementById("modEntrada").value;
    const nuevaSalida = document.getElementById("modSalida").value;
    const apiKey = document.getElementById("apiKeyInput").value;

    if (!apiKey) {
        alert("Por favor, ingresa tu clave de seguridad.");
        return;
    }

    if (!id) {
        alert("Error: ID no v√°lido.");
        return;
    }

    // Buscar registro completo
    const registro = window.registros.find(r => r.id === Number(id));
    if (!registro) {
        alert("Registro no encontrado");
        return;
    }

    // Usar las nuevas horas si fueron modificadas, de lo contrario usar las horas originales
    const fechaEntrada = nuevaEntrada || registro.entrada || "00:00";  // Si no se cambi√≥, usamos el valor actual o "00:00"
    const fechaSalida = nuevaSalida || registro.salida || "00:00";     // Lo mismo para HoraSalida

    // Mostrar las fechas antes de enviar para ver si todo est√° bien
    console.log("Fecha de entrada capturada:", fechaEntrada);
    console.log("Fecha de salida capturada:", fechaSalida);

    const payload = {
        Tabla: "RegEmpleados",
        ID: Number(id),
        Nombre: registro.empleado,
        Fecha: formatDate(registro.fecha), // Formateamos la fecha original tambi√©n
        HoraEntrada: fechaEntrada,         // Usamos la nueva hora si se modific√≥
        HoraSalida: fechaSalida,           // Usamos la nueva hora si se modific√≥
        Movimiento: "UPDATE"
    };

    // Mostrar el payload para depuraci√≥n
    console.log("Payload a enviar:", payload);

    try {
        const response = await fetch("https://rem.d5hx88s66m.workers.dev", {
            method: "POST",  // El Worker recibe POST para guardar
            headers: {
                "Content-Type": "application/json",
                "x-api-key": apiKey
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        console.log("RESPUESTA DEL WORKER:", result);

        if (response.ok) {
            alert("Horas actualizadas con √©xito");
            cerrarModal();
            cargarRegistros();  // Refrescar tabla
        } else {
            alert("Error al actualizar: " + (result.error || result));
        }

    } catch (err) {
        console.error(err);
        alert("No se pudo conectar con el servidor al actualizar las horas.");
    }
}




    
</script>    
</body>
</html>
